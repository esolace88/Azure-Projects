#cloud-config
package_upgrade: true
runcmd:
  - echo "[INFO] Installing java, git, unzip, gradle, ca-certs, curl, gnup, sshpass apt-transport-https"
  - sudo apt install openjdk-11-jre git unzip -y && sudo snap install gradle --classic
  - sudo apt-get install ca-certificates curl gnupg sshpass apt-transport-https -y
  - echo "[INFO] Adding Docker & Kubernetes Repository"
  - sudo install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg > /dev/null
  - sudo chmod a+r /etc/apt/keyrings/docker.gpg
  - echo "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
  - curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-archive-keyring.gpg
  - echo "deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list > /dev/null
  - echo "[INFO] Docker and K8s Enviroment set up"
  - cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
  - overlay
  - br_netfilter
  - EOF
  - sudo modprobe overlay && sudo modprobe br_netfilter
  - cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
  - net.bridge.bridge-nf-call-iptables  = 1
  - net.bridge.bridge-nf-call-ip6tables = 1
  - net.ipv4.ip_forward                 = 1
  - EOF
  - sudo sysctl --system
  - echo "[INFO] Installing Docker"
  - VERSION_STRING=5:23.0.1-1~ubuntu.20.04~focal
  - sudo apt-get update && sudo apt-get install docker-ce=$VERSION_STRING docker-ce-cli=$VERSION_STRING containerd.io docker-buildx-plugin docker-compose-plugin -y
  - echo "[INFO] Kube Config Requirements"
  - sudo sed -i 's/disabled_plugins/#disabled_plugins/' /etc/containerd/config.toml
  - sudo systemctl restart containerd
  - sudo swapoff -a
  - echo "[INFO] Installing Kubeadm"
  - sudo apt-get update && sudo apt-get install -y kubelet=1.24.0-00 kubeadm=1.24.0-00 kubectl=1.24.0-00
  - sudo apt-mark hold kubelet kubeadm kubectl
  - echo "[INFO] Done!!"